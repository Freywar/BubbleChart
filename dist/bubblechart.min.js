(function(){"use strict";

function namespace(){return{}}function cls(name,base,constructor){if(!base)throw Error("Undefined base class for "+name);constructor=constructor||eval(function(options){constructor.base.constructor.apply(this,arguments)});var originalConstructor=constructor;-1!==name.indexOf(".")?eval("var "+name.split(".")[0]+" = {};\n"+name.split(".")[0]+'["'+name.split(".").slice(1).join(".")+'"] = function(){\noriginalConstructor.apply(this, arguments)\n};\nconstructor = '+name.split(".")[0]+'["'+name.split(".").slice(1).join(".")+'"];'):constructor=eval("constructor = function "+name+"(options){\noriginalConstructor.apply(this, arguments)\n}");var f=new Function;return f.prototype=base.prototype,constructor.prototype=new f,constructor.prototype.constructor=constructor,constructor.base=base.prototype,constructor.property=property.bind(this,constructor),constructor.method=method.bind(this,constructor),constructor.alias=alias.bind(this,constructor),constructor.displayName=name,constructor}function property(cls,name,description){var prototype=cls.prototype;if(description=description||{},description.hasOwnProperty("value")&&(prototype["_"+name]=description.value),description.get===!0?prototype["get"+Utils.String.toUpperFirst(name)]=function(){return this["_"+name]}:description.get&&(prototype["get"+Utils.String.toUpperFirst(name)]=description.get),description.set===!0){if("function"==typeof description.type)prototype._objectProps=prototype._objectProps||[],prototype._objectProps.push(name);else if(description.hasOwnProperty("type"))throw Error("Unknown type");var setter=prototype["set"+Utils.String.toUpperFirst(name)]=function(value){"function"!=typeof description.type||value instanceof MObject||(value=new description.type(value)),this["_"+name]=value};"function"==typeof description.type&&(setter.initialize=!0)}else description.set&&(prototype["set"+Utils.String.toUpperFirst(name)]=description.set)}function method(cls,name,func){cls.prototype[name]=func||function(){abstract(name)},cls.prototype[name].displayName=(cls.displayName||cls.name)+"."+name}function abstract(name){throw Error((name||"This")+" is an abstract method.")}function MEvent(){this._handlers=null}function evt(obj,name){obj[name]=new MEvent}function Delegate(func,context){this._func=func,this._context=context}function delegate(obj_func,name_ctx){if("function"==typeof obj_func)return new Delegate(obj_func,name_ctx||window);var result=function(sender,args){result.handle.call(result,sender,args)};Delegate.call(result,obj_func[name_ctx],obj_func),result.handle=Delegate.prototype.handle,obj_func[name_ctx]=result}function alias(cls,name,otherName){cls.prototype[otherName]?cls.prototype[name]=cls.prototype[otherName]:(cls.prototype["_"+otherName]||cls.prototype["get"+Utils.String.toUpperFirst(otherName)]||cls.prototype["get"+Utils.String.toUpperFirst(otherName)])&&(cls.prototype["get"+Utils.String.toUpperFirst(name)]=cls.prototype["get"+Utils.String.toUpperFirst(otherName)],cls.prototype["set"+Utils.String.toUpperFirst(name)]=cls.prototype["set"+Utils.String.toUpperFirst(otherName)])}function enumeration(fields){return fields}MEvent.prototype.add=function(handler){this._handlers=this._handlers||[],this._handlers.push(handler)},MEvent.prototype.remove=function(handler){this._handlers&&~this._handlers.indexOf(handler)&&this._handlers.splice(this._handlers.indexOf(handler),1)},MEvent.prototype.clear=function(handler){this._handlers=null},MEvent.prototype.invoke=function(sender,args){if(this._handlers)for(var i=0;i<this._handlers.length;i++)this._handlers[i].handle(sender,args)};var delegateP=Delegate.prototype;delegateP.handle=function(sender,args){this._func.call(this._context,sender,args)},delegateP=null;var MObject=cls("MObject",Object,function(options){this._id="Object"+(Object.id=(Object.id||0)+1);for(var i in this){var setter;"_"===i[0]&&(setter=this["set"+Utils.String.toUpperFirst(i.slice(1))])&&setter.initialize&&setter.call(this,this[i])}this.update(options)});MObject.prototype.update=function(options){if(options)for(var i in options){var ui=Utils.String.toUpperFirst(i);if(this["set"+ui])this["set"+ui](options[i]);else{if(!(this[i]instanceof MEvent&&options[i]instanceof Delegate))throw Error("Unknown member "+i);this[i].add(options[i])}}},MObject.prototype.serialize=function(){var getter,result={};for(var i in this)if(0===i.indexOf("set")&&this[getter=i.replace(/^set/,"get")]){var r=this[getter]();r instanceof MObject&&(r=r.serialize()),result[Utils.String.toLowerFirst(i.replace(/^set/,""))]=r}return result},MObject.prototype.clone=function(){return new this.constructor(this.serialize())},window.Utils={extend:function(to,from){if(to=to||{},from)for(var i in from)to[i]=from[i];return to},DOM:{getScreenSize:function(){var w=window,d=document,e=d.documentElement,g=d.getElementsByTagName("body")[0],x=w.innerWidth||e.clientWidth||g.clientWidth,y=w.innerHeight||e.clientHeight||g.clientHeight;return{width:x,height:y}},create:function(tagName,className,parentNode,innerHTML,style){var result=document.createElement(tagName||"div");return result.className+=className||"",result.innerHTML=innerHTML||result.innerHTML,Utils.extend(result.style,style),parentNode&&parentNode.appendChild(result),result},bind:function(node,name,callback){window.addEventListener?node.addEventListener(name,callback,!1):window.attachEvent?node.attachEvent("on"+name,callback):node["on"+name]=callback},unbind:function(node,name,callback){window.addEventListener?node.removeEventListener(name,callback,!1):window.attachEvent?node.detachEvent("on"+name,callback):node["on"+name]=null}},String:{toUpperFirst:function(s){return s&&s[0].toUpperCase()+s.slice(1)},toLowerFirst:function(s){return s&&s[0].toLowerCase()+s.slice(1)}},Number:{normalize:function(v){return Math.max(0,Math.min(v,1))},clip:function(min,v,max){if(min>max){var t=min;min=max,max=t}return Math.max(min,Math.min(v,max))}},Types:{isObject:function(value){return"object"==typeof value},isNumber:function(value){return"number"==typeof value&&!isNaN(value)&&isFinite(value)},isInt:function(value){return this.isNumber(value)&&(0|value)===value},isFloat:function(value){return this.isNumber(value)&&!this.isInt(value)},isString:function(value){return"string"==typeof value},isFunction:function(value){return"function"==typeof value}},Random:{_seed:0,seed:function(seed){Utils.Random._seed=seed||Math.round(15054456*Math.random()),console.log("Random initialized with seed "+Utils.Random._seed)},next:function(){var hi=48271*Utils.Random._seed/2147483647,lo=Utils.Random._seed%(2147483647/48271),test=48271*lo-3399*hi;return(Utils.Random._seed=test>0?test:test+2147483647)/2147483647}},Array:{unique:function(array){return array.filter(function(o,i,a){return a.indexOf(o)===i})}},isOpera:!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFF:"undefined"!=typeof InstallTrigger,isSafari:Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isChrome:!!window.chrome&&!(window.opera||navigator.userAgent.indexOf(" OPR/")>=0),isIe:!!document.documentMode,AnimationFrame:{handlers:function(){var result=[];return function loop(){(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,13)})(function(){result.forEach(function(f){f({type:"animationframe",target:document.body})}),loop()})}(),result}(),add:function(func){Utils.AnimationFrame.handlers&&Utils.AnimationFrame.handlers.push(func)},remove:function(func){Utils.AnimationFrame.handlers&&Utils.AnimationFrame.handlers.splice(Utils.AnimationFrame.handlers.indexOf(func),1)}}},window.B=namespace(),window.delegate=delegate,B.Direction=enumeration({up:"up",left:"left",down:"down",right:"right"}),B.HAlign=enumeration({left:"left",center:"center",right:"right",fit:"fit",auto:"auto",none:"none"}),B.VAlign=enumeration({top:"top",center:"center",bottom:"bottom",fit:"fit",auto:"auto",none:"none"}),B.Color=cls("B.Color",MObject,function Color(options){function rgb(r,g,b){return{r:r/255,g:g/255,b:b/255,a:1}}function rgba(r,g,b,a){return{r:r/255,g:g/255,b:b/255,a:a}}function tryParse(value){var result=null;if(!Utils.Types.isString(value)||!value)return result;try{result=eval(value)}catch(e){console.log(e)}return result}var parsedAsFunction;if(Utils.Types.isString(options))switch(!0){case/^#[\da-f]{3}$/i.test(options):options={r:parseInt(options[1],16)/255,g:parseInt(options[2],16)/255,b:parseInt(options[3],16)/255,a:1};break;case/^#[\da-f]{6}$/i.test(options):options={r:parseInt(options.slice(1,3),16)/255,g:parseInt(options.slice(3,5),16)/255,b:parseInt(options.slice(5,7),16)/255,a:1};break;case!!(parsedAsFunction=tryParse(options)):options=parsedAsFunction;break;default:options={}}B.Color.base.constructor.call(this,options)}),B.Color.property("r",{value:0,get:!0,set:!0}),B.Color.property("g",{value:0,get:!0,set:!0}),B.Color.property("b",{value:0,get:!0,set:!0}),B.Color.property("a",{value:0,get:!0,set:!0}),B.Color.method("add",function(value){return value?new B.Color({r:Utils.Number.normalize(this._r+value),g:Utils.Number.normalize(this._g+value),b:Utils.Number.normalize(this._b+value),a:this._a}):this}),B.Color.method("toString",function(){return"rgba("+(255*this._r|0)+","+(255*this._g|0)+","+(255*this._b|0)+","+this._a+")"}),B.Color.method("apply",function(ctx){ctx.fillStyle=ctx.strokeStyle=this.toString()}),B.Border=cls("B.Border",MObject,function(options){Utils.Types.isString(options)&&(options=/^(\w+)px (\w+) (\w+)$/.exec(options),options&&(options={width:options[0],color:options[2]})),B.Border.base.constructor.call(this,options)}),B.Border.property("width",{value:0,get:!0,set:!0}),B.Border.property("color",{value:0,get:!0,set:!0,type:B.Color}),B.Border.property("radius",{value:0,get:!0,set:!0}),B.Border.method("toString",function(){return this._width+"px solid "+this._color.toString()}),B.Border.method("apply",function(ctx){ctx.strokeStyle=this._color.toString(),ctx.lineWidth=this._width}),B.Font=cls("B.Font",MObject,function(options){Utils.Types.isString(options)&&(options=/^(\w+ )?(\w+ )?(\w+ )?(\w+)px (\w+)$/.exec(options),options&&(options={family:options[options.length-1],size:options[options.length-2]})),B.Font.base.constructor.call(this,options)}),B.Font.property("family",{value:"Helvetica",get:!0,set:!0}),B.Font.property("size",{value:12,get:!0,set:!0}),B.Font.property("color",{value:"#000000",get:!0,set:!0,type:B.Color}),B.Font.method("toString",function(){return this._size+"px "+this._family}),B.Font.method("apply",function(ctx){ctx.fillStyle=ctx.strokeStyle=this._color.toString(),ctx.font=this.toString()}),B.Font.measureCtx=null,B.Font.method("measure",function(text){return B.Font.measureCtx=B.Font.measureCtx||document.createElement("canvas").getContext("2d"),B.Font.measureCtx.font=this.toString(),{width:B.Font.measureCtx.measureText(text).width,height:this._size}}),B.Animatable=cls("B.Animatable",MObject),B.Animatable.property("initialized",{value:!1}),B.Animatable.property("currentValue",{value:null,get:!0}),B.Animatable.property("nextValue",{value:null,get:!0}),B.Animatable.property("value",{get:function(){return this._currentValue},set:function(value){this._nextValue=value,this._initialized||(this._currentValue=this._nextValue,this._initialized=!0)}}),B.Animatable.method("animate",function(){return this._currentValue===this._nextValue?!1:(this._currentValue+=(this._nextValue-this._currentValue)/4,Math.abs(this._currentValue-this._nextValue)<.001&&(this._currentValue=this._nextValue),this._currentValue===this._nextValue&&(this._previousValue=this._currentValue),!0)}),B.Animatable.method("skip",function(){this._currentValue=this._nextValue}),B.Animatable.getter=function(name){return function(asObject){return this["_"+name]instanceof B.Animatable||(this["_"+name]=new B.Animatable({value:this["_"+name]})),asObject?this["_"+name]:this["_"+name].getValue()}},B.Animatable.setter=function(name){return function(value,asObject){this["_"+name]instanceof B.Animatable||(this["_"+name]=new B.Animatable({value:this["_"+name]})),asObject?this["_"+name]=value instanceof B.Animatable?value:new B.Animatable(value):this["_"+name].setValue(value)}},B.Rect=cls("B.Rect",MObject,function(options){B.Rect.base.constructor.apply(this,arguments)}),B.Rect.property("pinned",{value:!1,get:!0,set:!0}),B.Rect.property("left",{value:0,get:!0,set:function(value){this._pinned?(this._width-=value-this._left,this._width<0&&(this._left=this._left+this._width,this._width*=-1)):this._left=value}}),B.Rect.property("top",{value:0,get:!0,set:function(value){this._pinned?(this._height-=value-this._top,this._height<0&&(this._top=this._top+this._height,this._height*=-1)):this._top=value}}),B.Rect.property("width",{value:0,get:!0,set:!0}),B.Rect.property("height",{value:0,get:!0,set:!0}),B.Rect.property("right",{get:function(){return this._left+this._width},set:function(value){this._pinned?(this._width+=value-this.getRight(),this._width<0&&(this._left=this._left+this._width,this._width*=-1)):this._left=value-this._width}}),B.Rect.property("bottom",{get:function(){return this._top+this._height},set:function(value){this._pinned?(this._height+=value-this.getBottom(),this._height<0&&(this._top=this._top+this._height,this._height*=-1)):this._top=value-this._height}}),B.Rect.property("hCenter",{get:function(){return this._left+this._width/2},set:function(value){this._left=value-this._width/2}}),B.Rect.property("vCenter",{get:function(){return this._top+this._height/2},set:function(value){this._top=value-this._height/2}}),B.Spacing=cls("B.Spacing",MObject,function(options){Utils.Types.isNumber(options)&&(options={left:options,top:options,right:options,bottom:options}),B.Spacing.base.constructor.call(this,options)}),B.Spacing.property("left",{value:0,get:!0,set:!0}),B.Spacing.property("top",{value:0,get:!0,set:!0}),B.Spacing.property("right",{value:0,get:!0,set:!0}),B.Spacing.property("bottom",{value:0,get:!0,set:!0}),B.Control=cls("B.Control",B.Rect,function(options){evt(this,"invalidated"),B.Control.base.constructor.apply(this,arguments)}),B.Control.property("context",{value:null,get:!0,set:!0}),B.Control.property("enabled",{value:!0,get:!0,set:!0}),B.Control.property("visible",{value:!0,get:!0,set:!0}),B.Control.property("hAlign",{value:B.HAlign.none,get:!0,set:!0}),B.Control.property("vAlign",{value:B.VAlign.none,get:!0,set:!0}),B.Control.property("margin",{value:0,get:!0,set:!0,type:B.Spacing}),B.Control.property("padding",{value:4,get:!0,set:!0,type:B.Spacing}),B.Control.property("background",{value:null,get:!0,set:!0,type:B.Color}),B.Control.property("border",{value:null,get:!0,set:!0,type:B.Border}),B.Control.property("outerRect",{get:function(){return this}}),B.Control.alias("outerLeft","left"),B.Control.alias("outerTop","top"),B.Control.alias("outerWidth","width"),B.Control.alias("outerHeight","height"),B.Control.alias("outerRight","right"),B.Control.alias("outerBottom","bottom"),B.Control.alias("outerHCenter","hCenter"),B.Control.alias("outerVCenter","vCenter"),B.Control.property("innerRect",{get:function(){return new B.Rect({left:this.getInnerLeft(),top:this.getInnerTop(),width:this.getInnerWidth(),height:this.getInnerHeight()})}}),B.Control.property("innerLeft",{get:function(){return this._left+this._margin.getLeft()+this._border.getWidth()+this._padding.getLeft()+this._border.getRadius()}}),B.Control.property("innerTop",{get:function(){return this._top+this._margin.getTop()+this._border.getWidth()+this._padding.getTop()+this._border.getRadius()}}),B.Control.property("innerWidth",{get:function(){return Math.max(0,this._width-this._margin.getLeft()-this._margin.getRight()-2*this._border.getWidth()-this._padding.getLeft()-this._padding.getRight()-2*this._border.getRadius())}}),B.Control.property("innerHeight",{get:function(){return Math.max(0,this._height-this._margin.getTop()-this._margin.getBottom()-2*this._border.getWidth()-this._padding.getTop()-this._padding.getBottom()-2*this._border.getRadius())}}),B.Control.property("innerRight",{get:function(){return this.getInnerRect().getRight()}}),B.Control.property("innerBottom",{get:function(){return this.getInnerRect().getBottom()}}),B.Control.property("innerHCenter",{get:function(){return this.getInnerRect().getHCenter()}}),B.Control.property("innerVCenter",{get:function(){return this.getInnerRect().getVCenter()}}),B.Control.method("_assertReflow",function(failed){return this._context&&this._visible&&!failed?!1:(this._hAlign!==B.HAlign.none&&(this._width=0),this._vAlign!==B.VAlign.none&&(this._height=0),!0)}),B.Control.method("reflow",function(space){switch(this._hAlign){case B.HAlign.left:this._left=space.getLeft();break;case B.HAlign.center:this._left=space.getHCenter()-this._width/2;break;case B.HAlign.right:this._left=space.getRight()-this._width;break;case B.HAlign.fit:this._left=space.getLeft(),this._width=space.getWidth()}switch(this._vAlign){case B.VAlign.top:this._top=space.getTop();break;case B.VAlign.center:this._top=space.getVCenter()-this._height/2;break;case B.VAlign.bottom:this._top=space.getBottom()-this._height;break;case B.VAlign.fit:this._top=space.getTop(),this._height=space.getHeight()}}),B.Control.method("_clip",function(){this._context&&(this._context.save(),this._context.beginPath(),this._context.rect(Math.round(this._left+this._margin.getLeft()+this._border.getWidth()),Math.round(this._top+this._margin.getTop()+this._border.getWidth()),Math.round(this._width-this._margin.getLeft()-this._margin.getRight()-2*this._border.getWidth()),Math.round(this._height-this._margin.getTop()-this._margin.getBottom()-2*this._border.getWidth())),this._context.clip())}),B.Control.method("_unclip",function(){this._context&&this._context.restore()}),B.Control.method("_assertRepaint",function(failed){return!this._context||!this._visible||!this._width||!this._height||failed}),B.Control.method("repaint",function(){this._assertRepaint()||(this._background.apply(this._context),this._context.fillRect(Math.round(this._left+this._margin.getLeft()+this._border.getWidth()/2),Math.round(this._top+this._margin.getTop()+this._border.getWidth()/2),Math.round(this._width-this._margin.getLeft()-this._margin.getRight()-this._border.getWidth()),Math.round(this._height-this._margin.getTop()-this._margin.getBottom()-this._border.getWidth())),this._border.apply(this._context),this._context.strokeRect(Math.round(this._left+this._margin.getLeft()+this._border.getWidth()/2),Math.round(this._top+this._margin.getTop()+this._border.getWidth()/2),Math.round(this._width-this._margin.getLeft()-this._margin.getRight()-this._border.getWidth()),Math.round(this._height-this._margin.getTop()-this._margin.getBottom()-this._border.getWidth())))}),B.Control.property("_invalidateArgs",{value:null}),B.Control.method("_invalidate",function(reflow,repaint){(reflow||this._invalidateArgs&&this._invalidateArgs.reflow)&&this.reflow(this),(repaint||this._invalidateArgs&&this._invalidateArgs.repaint)&&this.repaint(),this._invalidateArgs=null}),B.Control.method("invalidate",function(reflow,repaint){this._invalidateArgs||setTimeout(this._invalidate.bind(this)),this._invalidateArgs=this._invalidateArgs||{},this._invalidateArgs.reflow=this._invalidateArgs.reflow||reflow,this._invalidateArgs.repaint=this._invalidateArgs.repaint||repaint}),B.Control.property("nativeHandler"),B.Control.method("_bindNative",function(node){this._nativeHandler=this._nativeHandler||this._handleNative.bind(this),Utils.DOM.bind(node,"mousemove",this._nativeHandler),Utils.DOM.bind(node,"mousedown",this._nativeHandler),Utils.DOM.bind(node,"mouseup",this._nativeHandler),Utils.DOM.bind(node,"click",this._nativeHandler),Utils.DOM.bind(node,"dblclick",this._nativeHandler),Utils.DOM.bind(node,Utils.isFF?"DOMMouseScroll":"mousewheel",this._nativeHandler),Utils.AnimationFrame.add(this._nativeHandler)}),B.Control.method("_handleNative",function(e){var rect=e.target.getBoundingClientRect(),args={type:e.type,x:e.pageX-rect.left,y:e.pageY-rect.top,cancel:!1,reflow:!1,repaint:!1,"native":e,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey};this._handle(args)}),B.Control.method("_unbindNative",function(node){this._nativeHandler&&(Utils.DOM.unbind(node,"mousemove",this._nativeHandler),Utils.DOM.unbind(node,"mousedown",this._nativeHandler),Utils.DOM.unbind(node,"mouseup",this._nativeHandler),Utils.DOM.unbind(node,"click",this._nativeHandler),Utils.DOM.unbind(node,"dblclick",this._nativeHandler),Utils.DOM.unbind(node,Utils.isFF?"DOMMouseScroll":"mousewheel",this._nativeHandler),Utils.AnimationFrame.remove(this._nativeHandler))}),B.Control.property("capture",{value:!1,get:!0}),B.Control.property("hovered",{value:!1,get:!0}),B.Control.property("pressed",{value:!1,get:!0}),B.Control.method("_check",function(x,y){return this.getInnerLeft()<=x&&x<=this.getInnerLeft()+this.getInnerWidth()&&this.getInnerTop()<=y&&y<=this.getInnerTop()+this.getInnerHeight()}),B.Control.method("_handle",function(args){if(this._capture||!args.cancel&&("animationframe"===args.type||this._check(args.x,args.y))){var type=args.type;Utils.isFF&&"DOMMouseScroll"===type&&(type="mousewheel");var handlerName="_on"+type.replace(/^(mouse|animation|dbl|click)?(.*)$/,function(_,f,e){return Utils.String.toUpperFirst(f||"")+Utils.String.toUpperFirst(e||"")});this[handlerName]&&this[handlerName](args)}}),B.Label=cls("B.Label",B.Control),B.Label.property("lines"),B.Label.property("text",{value:"",get:!0,set:!0}),B.Label.property("direction",{value:B.Direction.right,get:!0,set:!0}),B.Label.property("font",{value:null,get:!0,set:!0,type:B.Font}),B.Label.property("textAlign",{value:B.HAlign.left,get:!0,set:!0}),B.Label.method("reflow",function(space){if(!this._assertReflow(!this._text)){this._hAlign!==B.HAlign.none&&(this._width=space.getWidth()),this._vAlign!==B.VAlign.none&&(this._height=space.getHeight());for(var width=this._direction===B.Direction.left||this._direction===B.Direction.right?this.getInnerWidth():this.getInnerHeight(),height=this._direction===B.Direction.left||this._direction===B.Direction.right?this.getInnerHeight():this.getInnerWidth(),spaceSize=this._font.measure(" "),spaceWidth=spaceSize.width,threeDotsWidth=this._font.measure("...").width,lineHeight=spaceSize.height,lines=this._text.split("\n"),maxWidth=0,isLastLine=!1,i=0;i<lines.length&&!isLastLine;i++){isLastLine=height>=(i+1)*lineHeight&&(i+2)*lineHeight>height;for(var line="",lineWidth=0,words=lines[i].split(" "),lineSplitted=!1,j=0;j<words.length;j++){var rSpaceWidth=lineWidth?spaceWidth:0,llAdd=isLastLine?threeDotsWidth:0,wordWidth=this._font.measure(words[j]).width;if(!(width>lineWidth+rSpaceWidth+wordWidth+llAdd)){line||(isLastLine=!0),isLastLine&&j<words.length-1&&(line+="...",lineWidth+=llAdd),maxWidth=Math.max(maxWidth,lineWidth),lines.splice(i,0,line),lineSplitted=!0;break}line+=(line?" ":"")+words[j],lineWidth+=rSpaceWidth+wordWidth,maxWidth=Math.max(maxWidth,lineWidth)}lineSplitted||(line?lines[i]=line:(lines.splice(i,1),i--),isLastLine&&lines.length>i-1&&(lines[i]+="..."))}if(isLastLine&&lines.splice(i,lines.length-i),this._lines=lines,this._hAlign!==B.HAlign.none&&(this._width=maxWidth,this._width=this._width-this.getInnerWidth()+maxWidth),this._vAlign!==B.VAlign.none&&(this._height=lines.length*lineHeight,this._height=this._height-this.getInnerHeight()+lines.length*lineHeight),this._direction===B.Direction.up||this._direction===B.Direction.down){var t=this._width;this._width=this._height,this._height=t}B.Label.base.reflow.apply(this,arguments)}}),B.Label.method("_repaintText",function(){var oh=-this.getInnerHeight()/2,rotation=0;this._context.translate(Math.round(this._left+this._width/2),Math.round(this._top+this._height/2)),this._direction===B.Direction.up?(this._context.rotate(rotation=-Math.PI/2),oh=-this.getInnerWidth()/2):this._direction===B.Direction.down?(this._context.rotate(rotation=Math.PI/2),oh=-this.getInnerWidth()/2):this._direction===B.Direction.left&&this._context.rotate(rotation=-Math.PI),this._context.fillStyle=this._font.getColor().toString(),this._context.font=this._font.toString(),this._context.textBaseline="top";for(var i=0;i<this._lines.length;i++){var size=this._font.measure(this._lines[i]),x=Math.round(-size.width/2);this._textAlign===B.Direction.left&&(x=Math.round(-this.getInnerWidth()/2)),this._textAlign===B.Direction.right&&(x=Math.round((-this.getInnerWidth()-size.width)/2)),this._context.fillText(this._lines[i],x,Math.round(oh+i*size.height))}this._context.rotate(-rotation),this._context.translate(-Math.round(this._left+this._width/2),-Math.round(this._top+this._height/2))}),B.Label.method("repaint",function(){this._assertRepaint(!this._text)||(B.Label.base.repaint.apply(this,arguments),this._repaintText())}),B.Tooltip=cls("B.Tooltip",B.Label),B.Tooltip.property("x",{value:0,get:!0,set:!0}),B.Tooltip.property("y",{value:0,get:!0,set:!0}),B.Tooltip.property("offset",{value:0,get:!0,set:!0}),B.Tooltip.property("arrowWidth",{value:5,get:!0,set:!0}),B.Tooltip.property("arrowLength",{value:5,get:!0,set:!0}),B.Tooltip.property("arrowPosition",{value:.3,get:!0,set:!0}),B.Tooltip.property("arrowDirection",{value:B.Direction.up,get:!0,set:!0}),B.Tooltip.property("isOut",{value:!1,get:!0}),B.Tooltip.method("_flippingTest",function(coords,current,opposite,meaning){var delta=0,directionMultiplier=current===meaning?-1:1,sd=coords[current].limit-coords[current].value;if(coords[current].side!==coords.side&&0>sd*directionMultiplier&&!coords.flipped){coords.side=coords[current].side,coords.flipped=!0;var dvalue=coords[current].target-directionMultiplier*(coords[current].value+this._offset+this._arrowLength)-(1-directionMultiplier)*coords[meaning].value;coords[current].value+=dvalue,coords[opposite].value+=dvalue,sd-=dvalue}delta=sd-directionMultiplier*this._arrowLength,sd*directionMultiplier<this._arrowLength&&(this._isOut=!0,coords[current].value+=delta,coords[opposite].value+=delta)}),B.Tooltip.method("_rotatingTest",function(coords,current,opposite,otherIndex,otherOppositeIndex,otherMeaning,otherSecondary,meaning){var delta=coords[current].limit-coords[current].value,mult=current===meaning?-1:1,check=current!==meaning;if(0>delta*mult){coords[current].value+=delta,coords[opposite].value+=delta,coords.arrowOffset-=delta;var so=check?mult*(coords[current].value-coords[opposite].value):0;if(coords.arrowOffset*mult>so-coords.minOffset-this._arrowLength/2){coords.side=coords[current].side,coords.arrowOffset=-mult*(coords[otherIndex].value-coords[otherOppositeIndex].value)/2;var d1=coords[otherIndex].target-coords.arrowOffset-coords[otherMeaning].value;coords[otherIndex].value+=d1,coords[otherOppositeIndex].value+=d1;var d2=coords[meaning].target-mult*(this._offset+this._arrowLength)-so-coords[meaning].value;coords[current].value+=d2,coords[opposite].value+=d2,delta=coords[otherSecondary].limit-coords[otherSecondary].value,0>delta&&(coords[otherMeaning].value+=delta,coords[otherSecondary].value+=delta,coords.arrowOffset=Math.min(coords[otherSecondary].value-coords[otherMeaning].value-coords.minOffset-this._arrowLength/2,coords.arrowOffset-delta)),delta=coords[otherMeaning].limit-coords[otherMeaning].value,delta>0&&(coords[otherMeaning].value+=delta,coords[otherSecondary].value+=delta,coords.arrowOffset=Math.max(coords.minOffset+this._arrowLength/2,coords.arrowOffset-delta)),delta=coords[current].limit-coords[current].value-mult*this._arrowLength,0>delta*mult&&(this._isOut=!0,coords[current].value+=delta,coords[opposite].value+=delta)}}}),B.Tooltip.method("_calcPosition",function(top,left,arrowOffset,minOffset,space){if(space){var right=left+this.getWidth(),bottom=top+this.getHeight(),coords={side:this._arrowDirection,arrowOffset:arrowOffset,minOffset:minOffset,left:{value:left,limit:space.getLeft(),side:B.Direction.right,target:this._x},up:{value:top,limit:space.getTop(),side:B.Direction.down,target:this._y},right:{value:right,limit:space.getRight(),side:B.Direction.left,target:this._x},down:{value:bottom,limit:space.getBottom(),side:B.Direction.up,target:this._y}};return this._isOut=!1,this._arrowDirection===B.Direction.up||this._arrowDirection===B.Direction.down?(this._flippingTest(coords,B.Direction.up,B.Direction.down,B.Direction.up),this._flippingTest(coords,B.Direction.down,B.Direction.up,B.Direction.up),this._rotatingTest(coords,B.Direction.left,B.Direction.right,B.Direction.down,B.Direction.up,B.Direction.up,B.Direction.down,B.Direction.left),this._rotatingTest(coords,B.Direction.right,B.Direction.left,B.Direction.up,B.Direction.down,B.Direction.up,B.Direction.down,B.Direction.left)):(this._flippingTest(coords,B.Direction.left,B.Direction.right,B.Direction.left),this._flippingTest(coords,B.Direction.right,B.Direction.left,B.Direction.left),this._rotatingTest(coords,B.Direction.up,B.Direction.down,B.Direction.right,B.Direction.left,B.Direction.left,B.Direction.right,B.Direction.up),this._rotatingTest(coords,B.Direction.down,B.Direction.up,B.Direction.left,B.Direction.right,B.Direction.left,B.Direction.right,B.Direction.up)),top=coords[B.Direction.up].value,left=coords[B.Direction.left].value,{top:top,left:left,side:coords.side,arrowOffset:coords.arrowOffset}}}),B.Tooltip.method("reflow",function(space){if(!this._assertReflow(!this._text)){this._hAlign=B.HAlign.auto,this._vAlign=B.VAlign.auto,B.Tooltip.base.reflow.apply(this,arguments);var newCoords,left=0,top=0,arrowOffset=0,side=this._arrowDirection,innerWidth=this.getWidth(),innerHeight=this.getHeight(),borderR=this._border.getRadius(),borderW=this._border.getWidth();side=this._arrowDirection;var minOffset=borderR+this._arrowLength+0;side===B.Direction.up||side===B.Direction.down?(arrowOffset=innerWidth*this._arrowPosition,minOffset>arrowOffset&&(arrowOffset=minOffset),arrowOffset>innerWidth-minOffset&&(arrowOffset=innerWidth-minOffset),left=this._x-arrowOffset,side===B.Direction.up&&(top=this._y-innerHeight-this._offset-this._arrowLength),side===B.Direction.down&&(top=this._y+this._offset+this._arrowLength)):side===B.Direction.left||side===B.Direction.right?(arrowOffset=innerHeight*this._arrowPosition,minOffset>arrowOffset&&(arrowOffset=minOffset),arrowOffset>innerHeight-minOffset&&(arrowOffset=innerHeight-minOffset),top=this._y-arrowOffset,side===B.Direction.left&&(left=this._x-innerWidth-this._offset-this._arrowLength),side===B.Direction.right&&(left=this._x+this._offset+this._arrowLength)):(left=this._x-innerWidth/2,top=this._y-innerHeight/2),top-=borderW/2,left-=borderW/2,innerWidth+=borderW+1,innerHeight+=borderW+1,side&&(newCoords=this._calcPosition(top,left,arrowOffset,minOffset-this._arrowLength,space),newCoords&&(top=newCoords.top,left=newCoords.left,side=newCoords.side,arrowOffset=newCoords.arrowOffset)),top+=borderW/2,left+=borderW/2,innerWidth-=borderW+1,innerHeight-=borderW+1,this._data={width:innerWidth,height:innerHeight,side:side,arrowOffset:arrowOffset},this._left=left,this._top=top,this._width=innerWidth,this._height=innerHeight}}),B.Tooltip.property("data",{value:null}),B.Tooltip.method("repaint",function(){if(!this._assertRepaint(!this._text)){var side=this._data.side,arrowOffset=this._data.arrowOffset,borderW=this._border.getWidth(),borderR=this._border.getRadius(),aliasOffset=borderW%2/2,arrowStart=arrowOffset-this._arrowLength/2,arrowEnd=arrowOffset+this._arrowLength/2,cRight=this._width-borderR,cBottom=this._height-borderR;this._context.translate(Math.round(this._left)+aliasOffset,Math.round(this._top)+aliasOffset),this._context.beginPath(),this._context.moveTo(borderR,0),side===B.Direction.down&&(this._context.lineTo(arrowStart,0),this._context.lineTo(arrowOffset,-this._arrowLength),this._context.lineTo(arrowEnd,0)),this._context.arc(cRight,borderR,borderR,-Math.PI/2,0),side===B.Direction.left&&(this._context.lineTo(this._width,arrowStart),this._context.lineTo(this._width+this._arrowLength,arrowOffset),this._context.lineTo(this._width,arrowEnd)),this._context.arc(cRight,cBottom,borderR,0,Math.PI/2),side===B.Direction.up&&(this._context.lineTo(arrowEnd,this._height),
this._context.lineTo(arrowOffset,this._height+this._arrowLength),this._context.lineTo(arrowStart,this._height)),this._context.arc(borderR,cBottom,borderR,Math.PI/2,Math.PI),side===B.Direction.right&&(this._context.lineTo(0,arrowEnd),this._context.lineTo(-this._arrowLength,arrowOffset),this._context.lineTo(0,arrowStart)),this._context.arc(borderR,borderR,borderR,Math.PI,3*Math.PI/2),this._background.apply(this._context),this._context.fill(),this._border.apply(this._context),this._context.stroke(),this._context.translate(-Math.round(this._left)+aliasOffset,-Math.round(this._top)+aliasOffset),this._repaintText()}}),B.Bubble=cls("B.Bubble",B.Control,function(options){evt(this,"hover"),evt(this,"dblClick"),evt(this,"stateChange"),B.Bubble.base.constructor.apply(this,arguments)}),B.Bubble.method("_check",function(x,y){return x-=this.getX(),y-=this.getY(),Math.sqrt(x*x+y*y)<=this.getR()}),B.Bubble.method("_onMouseMove",function(args){var isInside=this._check(args.x,args.y),changed=this._hovered!==(this._hovered=this._capture=isInside&&!args.cancel);changed&&this.hover.invoke(this,Utils.extend({hover:isInside&&!args.cancel},args)),args.cancel=args.cancel||isInside}),B.Bubble.method("_onDblClick",function(args){this.dblClick.invoke(this,args)}),B.Bubble.method("_onAnimationFrame",function(args){var changed=!!(this.getLeft(!0).animate()+this.getTop(!0).animate()+this.getWidth(!0).animate()+this.getHeight(!0).animate()),state=this._state;changed&&this._state===B.Bubble.States.waiting&&(this._state=B.Bubble.States.appearing),changed||this._state!==B.Bubble.States.appearing||(this._state=B.Bubble.States.normal),changed||this._state!==B.Bubble.States.disappearing||(this._state=B.Bubble.States.disappeared),changed&&this.invalidated.invoke(this),state!==this._state&&this.stateChange.invoke(this,{state:this._state})}),B.Bubble.method("skip",function(){this.getLeft(!0).skip(),this.getTop(!0).skip(),this.getWidth(!0).skip(),this.getHeight(!0).skip()}),B.Bubble.property("path",{value:null,get:!0,set:!0}),B.Bubble.property("left",{get:B.Animatable.getter("left"),set:B.Animatable.setter("left")}),B.Bubble.property("top",{get:B.Animatable.getter("top"),set:B.Animatable.setter("top")}),B.Bubble.property("width",{get:B.Animatable.getter("width"),set:B.Animatable.setter("width")}),B.Bubble.property("height",{get:B.Animatable.getter("height"),set:B.Animatable.setter("height")}),B.Bubble.property("x",{get:function(){return this.getLeft()+this.getR()},set:function(value){this.setLeft(value-this.getWidth(!0).getNextValue()/2)}}),B.Bubble.property("y",{get:function(){return this.getTop()+this.getR()},set:function(value){this.setTop(value-this.getWidth(!0).getNextValue()/2)}}),B.Bubble.property("r",{get:function(){return this.getWidth()/2},set:function(value){var x=this.getLeft(!0).getNextValue()+this.getWidth(!0).getNextValue()/2,y=this.getTop(!0).getNextValue()+this.getWidth(!0).getNextValue()/2;this.setWidth(2*value),this.setHeight(2*value),this.setX(x),this.setY(y)}}),B.Bubble.property("color",{get:function(){return this._border.getColor()},set:function(value){this._border.setColor(value),this._border.setWidth(2);var fill=this._border.getColor().clone();fill.setA(fill.getA()/2),this.setBackground(fill)}}),B.Bubble.States=enumeration({waiting:"waiting",appearing:"appearing",normal:"normal",disappearing:"disappearing",disappeared:"disappeared"}),B.Bubble.property("state",{value:B.Bubble.States.waiting,get:!0,set:function(value){this._state=value,this.stateChange.invoke(this,{state:value})}}),B.Bubble.method("reflow",function(){}),B.Bubble.method("repaint",function(){this._assertRepaint(!this.getR())||(this._context.beginPath(),this._context.arc(this.getX(),this.getY(),Math.max(0,this.getR()-this._border.getWidth()/2),0,2*Math.PI),this._context.closePath(),this._background.add(this._hovered?-.2:0).apply(this._context),this._context.fill(),this._border.apply(this._context),this._border.getColor().add(this._hovered?-.2:0).apply(this._context),this._context.stroke())}),B.Data=cls("B.Data",MObject,function(options){B.Data.base.constructor.apply(this,arguments)}),B.Data.property("items",{value:null,get:!0,set:function(value){this._items=value;var initialized=!1;this._min=null,this._max=null,this._empty=!0,this._numeric=!0,this._minMaxCache=null;for(var queue=[value];queue.length;){var item=queue.pop();switch(!0){case Utils.Types.isObject(item):for(var i in item)queue.push(item[i]);break;case Utils.Types.isNumber(parseFloat(item)):this._empty=!1,initialized?this._numeric&&(this._min=Math.min(this._min,item),this._max=Math.min(this._max,item)):(this._min=this._max=parseFloat(item),initialized=!0);break;default:this._empty=!1,this._numeric=!0}}}}),B.Data.property("names",{value:null,get:!0,set:!0}),B.Data.property("empty",{value:!0,get:!0}),B.Data.property("numeric",{value:!1,get:!0}),B.Data.property("minMaxCache",{value:null}),B.Data.method("min",function(path){if(!this._numeric)return null;if(!path)return this._min;for(var cache=this._minMaxCache=this._minMaxCache||{},data=this._items,i=0;i<path.length;i++)if(data=data[path[i]],cache=cache[path[i]]=cache[path[i]]||[],!data)return null;if(!Utils.Types.isNumber(cache._min)){for(var min=null,queue=[data];queue.length;)switch(data=queue.pop(),!0){case Utils.Types.isObject(data):for(i in data)queue.push(data[i]);break;case Utils.Types.isNumber(data):min=null===min?data:Math.min(min,data)}cache._min=min}return cache._min}),B.Data.method("max",function(path){if(!this._numeric)return null;if(!path)return this._min;for(var cache=this._minMaxCache=this._minMaxCache||{},data=this._items,i=0;i<path.length;i++)if(data=data[path[i]],cache=cache[path[i]]=cache[path[i]]||[],!data)return null;if(!Utils.Types.isNumber(cache._max)){for(var max=null,queue=[data];queue.length;)switch(data=queue.pop(),!0){case Utils.Types.isObject(data):for(i in data)queue.push(data[i]);break;case Utils.Types.isNumber(data):max=null===max?data:Math.max(max,data)}cache._max=max}return cache._max}),B.Data.method("item",function(path){path=[].concat(path);for(var data=this._items;"object"==typeof data&&path.length;)data=data[path.shift()];return"object"==typeof data||path.length?null:data}),B.Data.method("name",function(path){path=[].concat(path);var names=this._names&&this._names[path.length-1];return names&&names[path.pop()]||""}),B.Transformer=cls("B.Transformer",MObject,function(options){B.Transformer.base.constructor.apply(this,arguments)}),B.Transformer.property("data",{value:null,get:!0,set:!0,type:B.Data}),B.Transformer.property("path",{value:null,get:!0,set:!0}),B.Transformer.property("min",{value:0,get:!0,set:!0}),B.Transformer.property("max",{value:1,get:!0,set:!0}),B.Transformer.property("nodata",{value:.5,get:!0,set:!0}),B.Transformer.property("minItem",{get:function(){if(!this._data||!this._data.getNumeric())return-1;var min=this._data.min(this._path),max=this._data.max(this._path);return min===max?min-1:min}}),B.Transformer.property("maxItem",{get:function(){if(!this._data||!this._data.getNumeric())return-1;var min=this._data.min(this._path),max=this._data.max(this._path);return min===max?max+1:max}}),B.Transformer.method("_interpolate",function(minV,v,maxV,minR,maxR){var dataRange=maxV-minV||1,dataOffset=v-minV,resultRange=maxR-minR;return minR+dataOffset*resultRange/dataRange}),B.Transformer.method("item",function(path1,path2,offset){if(!this._data||!this._data.getNumeric())return this._nodata;if(this._path&&(path1=this._path.concat(path1),path2&&(path2=this._path.concat(path2))),path2){var data1=this._data.item(path1),data2=this._data.item(path2);return Utils.Types.isNumber(data1)&&Utils.Types.isNumber(data1)?this._interpolate(0,offset,1,data1,data2):null}return this._data.item(path1)}),B.Transformer.method("transform",function(item){return Utils.Types.isNumber(item)?this._interpolate(this.getMinItem(),item,this.getMaxItem(),this._min,this._max):this._nodata}),B.Transformer.method("transformedItem",function(path1,path2,offset){if(path2){var data1=this.transform(this.item(path1)),data2=this.transform(this.item(path2));return this._interpolate(0,offset||0,1,data1,data2)}return this.transform(this.item(path1))}),B.Transformer.method("name",function(path){return this._path&&(path=this._path.concat(path||[])),this._data&&this._data.name(path)}),B.ColorTransformer=cls("B.ColorTransformer",B.Transformer),B.ColorTransformer.property("min",{value:"#FF0000",get:!0,set:!0,type:B.Color}),B.ColorTransformer.property("max",{value:"#00FF00",get:!0,set:!0,type:B.Color}),B.ColorTransformer.property("nodata",{value:"#AAAAAA",get:!0,set:!0,type:B.Color}),B.ColorTransformer.method("transform",function(value){if(!Utils.Types.isNumber(value))return this._nodata;var result=new B.Color;return result.setR(this._interpolate(this.getMinItem(),value,this.getMaxItem(),this._min.getR(),this._max.getR())),result.setG(this._interpolate(this.getMinItem(),value,this.getMaxItem(),this._min.getG(),this._max.getG())),result.setB(this._interpolate(this.getMinItem(),value,this.getMaxItem(),this._min.getB(),this._max.getB())),result.setA(this._interpolate(this.getMinItem(),value,this.getMaxItem(),this._min.getA(),this._max.getA())),result.toString()}),B.ColorTransformer.method("transformedItem",function(path1,path2,offset){if(path2){var data1=new B.Color(this.transform(this.item(path1))),data2=new B.Color(this.transform(this.item(path2))),result=new B.Color;return result.setR(this._interpolate(0,offset||0,1,data1.getR(),data2.getR())),result.setG(this._interpolate(0,offset||0,1,data1.getG(),data2.getG())),result.setB(this._interpolate(0,offset||0,1,data1.getB(),data2.getB())),result.setA(this._interpolate(0,offset||0,1,data1.getA(),data2.getA())),result.toString()}return this.transform(this.item(path1))}),B.Line=cls("B.Line",B.Control),B.Line.property("x1",{get:function(){return this._left},set:function(value){this._left=value}}),B.Line.property("y1",{get:function(){return this._top},set:function(value){this._top=value}}),B.Line.property("x2",{get:function(){return this._left+this._width},set:function(value){this._width=value-this._left}}),B.Line.property("y2",{get:function(){return this._top+this._height},set:function(value){this._height=value-this._top}}),B.Line.alias("stroke","border"),B.Line.method("reflow",function(){}),B.Line.method("repaint",function(){if(this._context&&this._visible&&this._border.getWidth()){var pixelOffset=this._border.getWidth()%2/2;this._border.apply(this._context),this._context.beginPath(),this._context.moveTo(Math.round(this.getX1())+pixelOffset,Math.round(this.getY1())+pixelOffset),this._context.lineTo(Math.round(this.getX2())+pixelOffset,Math.round(this.getY2())+pixelOffset),this._context.stroke()}}),B.Scale=cls("B.Scale",B.Rect),B.Scale.property("padding",{value:0,get:!0,set:!0,type:B.Spacing}),B.Scale.property("offsetX",{value:0,get:!0,set:function(value){1-this._scaleX;this._offsetX=Utils.Number.clip((this.getLeft()+this._padding.getLeft())*(1-this._scaleX),value,(this.getRight()-this._padding.getRight())*(1-this._scaleX))}}),B.Scale.property("offsetY",{value:0,get:!0,set:function(value){1-this._scaleY;this._offsetY=Utils.Number.clip((this.getTop()+this._padding.getTop())*(1-this._scaleY),value,(this.getBottom()-this._padding.getBottom())*(1-this._scaleY))}}),B.Scale.property("scaleX",{value:1,get:!0,set:function(value){this._scaleX=Utils.Number.clip(this._minScaleX,value,this._maxScaleX)}}),B.Scale.property("scaleY",{value:1,get:!0,set:function(value){this._scaleY=Utils.Number.clip(this._minScaleY,value,this._maxScaleY)}}),B.Scale.property("minScaleX",{value:1,get:!0,set:function(value){this._minScaleX=value,this._maxScaleX=Math.max(value,this._maxScaleX),this.setScaleX(this._scaleX)}}),B.Scale.property("minScaleY",{value:1,get:!0,set:function(value){this._minScaleY=value,this._maxScaleY=Math.max(value,this._maxScaleY),this.setScaleY(this._scaleY)}}),B.Scale.property("maxScaleX",{value:10,get:!0,set:function(value){this._maxScaleX=value,this._minScaleX=Math.min(value,this._minScaleX),this.setScaleX(this._scaleX)}}),B.Scale.property("maxScaleY",{value:10,get:!0,set:function(value){this._maxScaleY=value,this._minScaleY=Math.min(value,this._minScaleY),this.setScaleY(this._scaleY)}}),B.Scale.method("scaleTo",function(rect){var pScaleX=this._scaleX,pScaleY=this._scaleY;this.setScaleX(this._scaleX*this.getWidth()/rect.getWidth()),this.setScaleY(this._scaleY*this.getHeight()/rect.getHeight()),this.setOffsetX(this._offsetX+this.getLeft()-rect.getLeft()+(this._offsetX-rect.getLeft())*(this._scaleX/pScaleX-1)),this.setOffsetY(this._offsetY+this.getTop()-rect.getTop()+(this._offsetY-rect.getTop())*(this._scaleY/pScaleY-1))}),B.Scale.method("scaleBy",function(addend,x,y){Utils.Types.isNumber(x)||(x=this.getCenterX()),Utils.Types.isNumber(y)||(y=this.getCenterY());var pScaleX=this._scaleX,pScaleY=this._scaleY;this.setScaleX(this._scaleX+addend),this.setScaleY(this._scaleY+addend),this.setOffsetX(this._offsetX+(this._offsetX-x)*(this._scaleX/pScaleX-1)),this.setOffsetY(this._offsetY+(this._offsetY-y)*(this._scaleY/pScaleY-1))}),B.Scale.method("moveBy",function(dx,dy){this.setOffsetX(this._offsetX+dx),this.setOffsetY(this._offsetY+dy)}),B.Scale.method("x",function(x){return((this.getLeft()+this._padding.getLeft())*(1-x)+(this.getRight()-this._padding.getRight())*x)*this._scaleX+this._offsetX}),B.Scale.method("y",function(y){return((this.getTop()+this._padding.getTop())*(1-y)+(this.getBottom()-this._padding.getBottom())*y)*this._scaleY+this._offsetY}),B.ControlCollection=cls("B.ControlCollection",B.Control),B.ControlCollection.property("items",{value:null}),B.ControlCollection.property("values",{value:null}),B.ControlCollection.property("class",{value:B.Control,get:!0}),B.ControlCollection.property("options",{value:null,get:!0,set:!0}),B.ControlCollection.property("min",{value:0,get:!0,set:!0}),B.ControlCollection.property("max",{value:0,get:!0,set:!0}),B.ControlCollection.property("count",{value:0,get:!0,set:!0}),B.ControlCollection.property("transformer",{value:null,get:!0,set:!0,type:B.Transformer}),B.ControlCollection.property("scale",{value:null,get:!0,set:!0,type:B.Scale}),B.ControlCollection.property("direction",{value:B.Direction.right,get:!0,set:!0}),B.ControlCollection.property("subcollection",{value:null,get:!0,set:!0}),B.ControlCollection.property("subcollections",{value:null}),B.ControlCollection.property("master",{value:null}),B.ControlCollection.property("slave",{value:null}),B.ControlCollection.method("synchronize",function(other){this._slave=other,other&&(other.master=this)}),B.ControlCollection.method("_recreate",function(){if(!this._class||!Utils.Types.isFunction(this._class)||!this._count)return void(this._items=this._values=this._subcollections=null);this._items=[],this._values=[];for(var i=0;i<this._count;i++)this._items[i]=new this._class(this._options),this._values[i]=this._min+i*(this._max-this._min)/(this._count-1);if(this._subcollection)for(this._subcollections=[],i=0;i<this._values.length-1;i++)this._subcollections[i]=new this.constructor(this._subcollection),this._subcollections[i].setMin(this._values[i]),this._subcollections[i].setMax(this._values[i+1])}),B.ControlCollection.method("_applyValue"),B.ControlCollection.method("_reflowChildren",function(space){if(this._context&&this._visible){this.setPadding(0),(!this._items||!this._values||this._subcollection&&!this._subcollections||this._items.length!==this._count||this._values.length!==this._count||this._subcollection&&this._subcollections&&this._subcollections.length!==this._count-1||this._values[0]!==this._min||this._values[this._values.length-1]!==this._max)&&this._recreate();for(var size=0,i=0;i<this._items.length;i++)this._applyValue(this._items[i],this._values[i]),this._items[i].setContext(this._context),this._items[i].setVisible(!0),this._items[i].setHAlign(B.HAlign.auto),this._items[i].setVAlign(B.VAlign.auto),this._items[i].reflow(space),size=Math.max(size,this._direction===B.Direction.up||this._direction===B.Direction.down?this._items[i].getWidth():this._items[i].getHeight()),this._subcollections&&this._subcollections[i]&&(this._subcollections[i].setContext(this._context),this._subcollections[i].setHAlign(this._hAlign),this._subcollections[i].setVAlign(this._vAlign),this._subcollections[i].setDirection(this._direction),this._subcollections[i].setScale(this._scale),size=Math.max(size,this._subcollections[i]._reflowChildren(space)));return(this._direction===B.Direction.up||this._direction===B.Direction.down&&this._hAlign!==B.HAlign.none)&&(this._width=size,this._width=this._width-this.getInnerWidth()+size),(this._direction===B.Direction.left||this._direction===B.Direction.right&&this._vAlign!==B.VAlign.none)&&(this._height=size,this._height=this._height-this.getInnerHeight()+size),size}}),B.ControlCollection.method("_reflowSelf",function(space,callBase){if(callBase&&B.ControlCollection.base.reflow.apply(this,arguments),this._subcollections)for(var i=0;i<this._subcollections.length;i++)this._subcollections[i].setTransformer(this._transformer),this._subcollections[i].setLeft(this._left),this._subcollections[i].setTop(this._top),this._subcollections[i].setWidth(this._width),this._subcollections[i].setHeight(this._height),this._subcollections[i]._reflowSelf(space)}),B.ControlCollection.method("_realignChildren",function(){for(var i=0;i<this._items.length;i++){var position=this._transformer.transform(this._values[i]);this._direction===B.Direction.up||this._direction===B.Direction.down?(this._hAlign===B.HAlign.left?this._items[i].setLeft(this.getInnerLeft()+this.getInnerWidth()-this._items[i].getWidth()):this._hAlign===B.HAlign.right?this._items[i].setLeft(this.getInnerLeft()):this._items[i].setLeft(this.getInnerLeft()+this.getInnerWidth()/2-this._items[i].getWidth()/2),this._direction===B.Direction.up&&(position=1-position),this._items[i].setTop(this._scale.y(position)-this._items[i].getHeight()/2)):(this._vAlign===B.VAlign.top?this._items[i].setTop(this.getInnerTop()+this.getInnerHeight()-this._items[i].getHeight()):this._vAlign===B.HAlign.bottom?this._items[i].setTop(this.getInnerTop()):this._items[i].setTop(this.getInnerTop()+this.getInnerHeight()/2-this._items[i].getHeight()/2),this._direction===B.Direction.left&&(position=1-position),this._items[i].setLeft(this._scale.x(position)-this._items[i].getWidth()/2)),this._subcollections&&this._subcollections[i]&&this._subcollections[i]._realignChildren()}}),B.ControlCollection.method("reflow",function(space,realignOnly){this._context&&this._visible&&(realignOnly||(this._reflowChildren(space),this._reflowSelf(space,!0)),this._realignChildren())}),B.ControlCollection.method("_repaint",function(currentLevel,levelToRender){if(this._context&&this._visible)if(levelToRender){if(this._subcollections)for(var i=0;i<this._subcollections.length;i++)this._subcollections[i]._repaint(currentLevel+1,levelToRender-1)}else{if(!Utils.Types.isNumber(levelToRender)&&this._subcollections)for(var i=0;i<this._subcollections.length;i++)this._subcollections[i]._repaint(currentLevel+1);this._slave&&this._slave._repaint(0,currentLevel);for(var i=0;i<this._items.length;i++)this._items[i].repaint()}}),B.ControlCollection.method("repaint",function(){this._master||(this._clip(),this._repaint(0),this._unclip())}),B.LineCollection=cls("B.LineCollection",B.ControlCollection),B.LineCollection.property("class",{value:B.Line,get:!0}),B.LineCollection.property("options",{value:{stroke:"#FFFFFF"}}),B.LineCollection.method("_reflowChildren",function(space){if(this._context&&this._visible){(!this._items||!this._values||this._subcollection&&!this._subcollections||this._items.length!==this._count||this._values.length!==this._count||this._subcollection&&this._subcollections&&this._subcollections.length!==this._count-1||this._values[0]!==this._min||this._values[this._values.length-1]!==this._max)&&this._recreate();for(var i=0;i<this._items.length;i++)this._items[i].setContext(this._context),this._subcollections&&this._subcollections[i]&&(this._subcollections[i].setContext(this._context),this._subcollections[i].setScale(this._scale),this._subcollections[i]._reflowChildren(space))}}),B.LineCollection.method("_realignChildren",function(){for(var i=0;i<this._items.length;i++){var position=this._transformer.transform(this._values[i]);this._direction===B.Direction.up||this._direction===B.Direction.down?(this._direction===B.Direction.up&&(position=1-position),this._items[i].setX1(this.getInnerLeft()),this._items[i].setY1(this._scale.y(position)),this._items[i].setX2(this.getInnerLeft()+this.getInnerWidth()),this._items[i].setY2(this._scale.y(position))):(this._direction===B.Direction.left&&(position=1-position),this._items[i].setX1(this._scale.x(position)),this._items[i].setY1(this.getInnerTop()),this._items[i].setX2(this._scale.x(position)),this._items[i].setY2(this.getInnerTop()+this.getInnerHeight())),this._subcollections&&this._subcollections[i]&&(this._subcollections[i].setHAlign(this._hAlign),this._subcollections[i].setVAlign(this._vAlign),this._subcollections[i].setDirection(this._direction),this._subcollections[i]._realignChildren())}}),B.LineCollection.method("reflow",function(space){this.setPadding(0),B.LineCollection.base.reflow.apply(this,arguments)}),B.LabelCollection=cls("B.LabelCollection",B.ControlCollection),B.LabelCollection.property("class",{value:B.Label,get:!0}),B.LabelCollection.method("_applyValue",function(item,value){item.setText(value.toFixed(2))}),B.LabelCollection.method("_hideOverlappingChildren",function(left,right){for(var i=0;i<this._items.length;i++)this._items[i].getLeft()<left||this._items[i].getLeft()+this._items[i].getWidth()>right?this._items[i].setVisible(!1):(this._items[i].setVisible(!0),left=this._items[i].getLeft()+this._items[i].getWidth());for(i=0;i<this._items.length-1;i++)this._subcollections&&this._subcollections[i]&&(this._items[i].getVisible()&&this._items[i+1].getVisible()?this._subcollections[i]._hideOverlappingChildren(this._items[i].getRight(),this._items[i+1].getLeft()):this._subcollections[i]._hideOverlappingChildren(1,-1))}),B.LabelCollection.method("reflow",function(){if(B.LabelCollection.base.reflow.apply(this,arguments),this._items&&this._direction===B.Direction.right){var first=this._items[0],last=this._items[this._items.length-1];first.getRight()>this.getInnerLeft()&&first.setLeft(Math.max(first.getLeft(),this.getInnerLeft())),last.getRight()<this.getInnerRight()&&last.setRight(Math.min(last.getRight(),this.getInnerRight())),this._hideOverlappingChildren(-(1/0),1/0)}}),B.Axis=cls("B.Axis",B.Control),B.Axis.property("title",{value:null,get:!0,set:!0,type:B.Label}),B.Axis.property("grid",{value:null,get:!0,set:!0,type:B.LineCollection}),B.Axis.property("labels",{value:null,get:!0,set:!0,type:B.LabelCollection}),B.Axis.method("reflow",function(space){this._assertReflow()||(B.Axis.base.reflow.apply(this,arguments),this._grid&&(this._grid.setContext(this._context),this._grid.setHAlign(B.HAlign.fit),this._grid.setVAlign(B.VAlign.fit),this._grid.reflow(space)))}),B.Axis.method("repaint",function(){this._assertRepaint()||this._grid&&this._grid.repaint()}),B.Plot=cls("B.Plot",B.Control,function(options){evt(this,"scaleChange"),B.Plot.base.constructor.apply(this,arguments),this._scale=new B.Scale}),B.Plot.property("x",{value:null,get:!0,set:!0,type:B.Axis}),B.Plot.property("y",{value:null,get:!0,set:!0,type:B.Axis}),B.Plot.property("scale",{get:!0}),B.Plot.method("_onMouseWheel",function(event){var delta=(Utils.isFF?-event["native"].detail:event["native"].wheelDelta)>0?.1:-.1;this._scale.scaleBy(delta,event.x,event.y),this.scaleChange.invoke(this)}),B.Plot.property("_previousDragEvent"),B.Plot.method("_onMouseDown",function(event){this._previousDragEvent=event,this._capture=!0}),B.Plot.method("_onMouseMove",function(event){this._previousDragEvent&&(this._scale.moveBy(event.x-this._previousDragEvent.x,event.y-this._previousDragEvent.y),this._previousDragEvent=event,this.scaleChange.invoke(this))}),B.Plot.method("_onMouseUp",function(event){this._previousDragEvent=null,this._capture=!1}),B.Plot.method("reflow",function(space){if(!this._assertReflow()){this._x&&this._y&&this._x.getGrid()&&this._y.getGrid()&&this._x.getGrid().synchronize(this._y.getGrid()),B.Plot.base.reflow.apply(this,arguments);var rect=new B.Rect({left:this.getInnerLeft(),top:this.getInnerTop(),width:this.getInnerWidth(),height:this.getInnerHeight()});this._x&&(this._x.setContext(this._context),this._x.setHAlign(B.HAlign.fit),this._x.setVAlign(B.VAlign.fit),this._x.reflow(rect)),this._y&&(this._y.setContext(this._context),this._y.setHAlign(B.HAlign.fit),this._y.setVAlign(B.VAlign.fit),this._y.reflow(rect))}}),B.Plot.method("repaint",function(){this._assertRepaint()||(B.Plot.base.repaint.apply(this,arguments),this._clip(),this._x&&this._x.repaint(),this._y&&this._y.repaint(),this._unclip())}),B.BubbleLabel=cls("B.BubbleLabel",B.Control,function(options){B.BubbleLabel.base.constructor.apply(this,arguments),this._bubble=new B.Bubble,this._label=new B.Label}),B.BubbleLabel.property("bubble"),B.BubbleLabel.property("label"),B.BubbleLabel.property("text",{get:!0,set:!0}),B.BubbleLabel.property("font",{get:!0,set:!0,type:B.Font}),B.BubbleLabel.property("radius",{value:8,get:!0,set:!0}),B.BubbleLabel.property("color",{value:"#888888",get:!0,set:!0,type:B.Color}),B.BubbleLabel.method("reflow",function(space){if(!this._assertReflow(!this._text||!this._radius)){this._label.setContext(this._context),this._label.setHAlign(B.HAlign.auto),this._label.setVAlign(B.VAlign.auto),this._label.setText(this._text),this._label.setFont(this._font),this._label.reflow(space),this._bubble.setContext(this._context);var width=2*this._radius+this._label.getWidth();this._hAlign!==B.HAlign.none&&(this._width=width,this._width=this._width-this.getInnerWidth()+width);var height=Math.max(2*this._radius,this._label.getHeight());this._vAlign!==B.VAlign.none&&(this._height=height,this._height=this._height-this.getInnerHeight()+height),B.BubbleLabel.base.reflow.apply(this,arguments),this._bubble.setX(this.getInnerLeft()+this.getInnerWidth()/2-width/2+this._radius),this._bubble.setY(this.getInnerTop()+this.getInnerHeight()/2),this._bubble.setR(this._radius),this._bubble.setColor(this._color),this._bubble.skip(),this._label.setLeft(this.getInnerLeft()+this.getInnerWidth()/2-width/2+2*this._radius),this._label.setTop(this.getInnerTop()+this.getInnerHeight()/2-this._label.getHeight()/2)}}),B.BubbleLabel.method("repaint",function(){this._assertRepaint(!this._text||!this._radius)||(B.BubbleLabel.base.repaint.apply(this,arguments),this._bubble.repaint(),this._label.repaint())}),B.Legend=cls("B.Legend",B.Control,function(){B.Legend.base.constructor.apply(this,arguments),this._contItem=new B.BubbleLabel({radius:0,text:"..."})}),B.Legend.property("rows"),B.Legend.property("contItem"),B.Legend.property("title",{value:null,get:!0,set:!0,type:B.Label}),B.Legend.property("items",{value:null,get:!0,set:function(value){if(value!==this._items&&(this._items=[],value))for(var i=0;i<value.length;i++)this._items.push(new B.BubbleLabel(value[i]))}}),B.Legend.property("font",{value:null,get:!0,set:!0,type:B.Font}),B.Legend.method("reflow",function(space){if(!this._assertReflow(!this._items||!this._items.length)){for(var i=0;i<this._items.length;i++)this._items[i].setContext(this._context),this._items[i].setHAlign(B.HAlign.auto),this._items[i].setVAlign(B.VAlign.auto),this._items[i].setFont(this._font),this._items[i].reflow(space);this._contItem.setContext(this._context),this._contItem.setHAlign(B.HAlign.auto),this._contItem.setVAlign(B.VAlign.auto),this._contItem.setFont(this._font),this._contItem.reflow(space),this._hAlign!==B.HAlign.none&&(this._width=space.getWidth()),this._vAlign!==B.VAlign.none&&(this._height=space.getHeight());var width=0,height=0,rows=[],row={items:[],width:0,height:0};for(i=0;i<this._items.length;i++)if(row.width+this._items[i].getWidth()<=this.getInnerWidth())row.items.push(this._items[i]),row.width+=this._items[i].getWidth(),row.height=Math.max(row.height,this._items[i].getHeight());else{if(!(height+row.height<=this.getInnerHeight())){rows.length&&rows[rows.length-1].items.length&&(rows[rows.length-1].items[rows[rows.length-1].items.length-1]=this._contItem),row=null;break}height+=row.height,width=Math.max(row.width,width),rows.push(row),row={items:[],width:0,height:0},i--}row&&(height+=row.height,width=Math.max(row.width,width),rows.push(row)),this._title&&(this._title.setContext(this._context),this._title.setHAlign(B.HAlign.auto),this._title.setVAlign(B.HAlign.auto),this._title.reflow(space),width=Math.max(width,this._title.getWidth()),height+=this._title.getHeight()),this._hAlign!==B.HAlign.none&&(this._width=width,this._width=this._width-this.getInnerWidth()+width),this._vAlign!==B.VAlign.none&&(this._height=height,this._height=this._height-this.getInnerHeight()+height),B.Legend.base.reflow.apply(this,arguments);var top=this.getInnerTop()+this.getInnerHeight()/2-height/2;this._title&&(this._title.setLeft(this.getInnerLeft()+this.getInnerWidth()/2-this._title.getWidth()/2),this._title.setTop(top),top+=this._title.getHeight(),height-=this._title.getHeight());var y=0;for(i=0;i<rows.length;i++){for(var x=0,j=0;j<rows[i].items.length;j++)rows[i].items[j].setLeft(this.getInnerLeft()+this.getInnerWidth()/2-rows[i].width/2+x),rows[i].items[j].setTop(top+y+rows[i].height/2-rows[i].items[j].getHeight()/2),rows[i].items[j].reflow(space),x+=rows[i].items[j].getWidth();y+=rows[i].height}this._rows=rows}}),B.Legend.method("repaint",function(){if(!this._assertRepaint(!this._items||!this._items.length)){B.Legend.base.repaint.apply(this,arguments),this._title&&this._title.repaint();for(var i=0;i<this._rows.length;i++)for(var j=0;j<this._rows[i].items.length;j++)this._rows[i].items[j].repaint()}}),B.ValueLegend=cls("B.ValueLegend",B.Legend),B.ValueLegend.property("transformer",{value:null,get:!0,set:!0,type:B.Transformer}),B.ValueLegend.property("count",{value:3,get:!0,set:!0}),B.ValueLegend.method("_recreate",function(){if(this._visible&&this._context&&this._transformer){var min=this._transformer.getMinItem(),max=this._transformer.getMaxItem();if(!this._items||this._items.length!==this._count||this._items[0].getText()!==min.toFixed(2)||this._items[this._items.length-1].getText()!==max.toFixed(2)){if(this._items=[],Utils.Types.isNumber(min)&&Utils.Types.isNumber(max))for(var i=0;i<this._count;i++){var value=min+i*(max-min)/(this._count-1),tValue=this._transformer.transform(value),options={text:value.toFixed(2)};Utils.Types.isString(tValue)?options.color=tValue:options.radius=50*tValue,this._items.push(new B.BubbleLabel(options))}var noptions={text:"no data"},nValue=this._transformer.transform(null);Utils.Types.isString(tValue)?noptions.color=nValue:noptions.radius=50*nValue,this._items.push(new B.BubbleLabel(noptions))}}}),B.ValueLegend.method("reflow",function(space){this._title&&this._transformer&&this._title.setText(this._transformer.name()),this._recreate(),B.ValueLegend.base.reflow.apply(this,arguments)}),B.Slider=cls("B.Slider",B.Control,function(options){evt(this,"positionChange"),B.Slider.base.constructor.apply(this,arguments)}),B.Slider.property("_buttonHovered",{value:!1}),B.Slider.property("_sliderHovered",{value:!1}),B.Slider.property("_sliderDragged",{value:!1}),B.Slider.property("_sliderAnimated",{value:!1}),B.Slider.property("_sliderAnimatedPrevTime",{value:null}),B.Slider.method("_startPadding",function(){return this._ticks&&this._ticks[0]?Math.max(9,this._ticks[0].getWidth()/2):9}),B.Slider.method("_endPadding",function(){return this._ticks&&this._ticks[this._ticks.length-1]?Math.max(9,this._ticks[this._ticks.length-1].getWidth()/2):9}),B.Slider.method("_onMouseDown",function(args){var start=this.getInnerLeft()+32+this._padding.getLeft(),length=this.getInnerLeft()+this.getInnerWidth()-start,st=this.getInnerTop()+16.5;this._sliderDragged=args.x>=start&&args.x<=start+length&&args.y>=st-9&&args.y<=st+9,this._sliderDragged&&(this._capture=!0,this._sliderAnimated=!1,
this._onMouseMove(args))}),B.Slider.method("_onMouseMove",function(args){var start=this.getInnerLeft()+32+this._padding.getLeft()+this._startPadding(),length=this.getInnerLeft()+this.getInnerWidth()-start-this._endPadding();if(this._sliderDragged)this._position=Utils.Number.normalize((args.x-start)/length),this.offset()<.03&&(this._position=Math.floor(this._position*(this._ticks.length-1))/(this._ticks.length-1)),this.offset()>.97&&(this._position=Math.ceil(this._position*(this._ticks.length-1))/(this._ticks.length-1)),this.positionChange.invoke(this,{position:this._position,animation:this._sliderAnimated});else{var sl=start+length*this._position,st=this.getInnerTop()+16.5,capture=!1,changed=!1;changed=args.x>=this.getInnerLeft()&&args.x<=this.getInnerLeft()+32&&args.y>=this.getInnerTop()&&args.y<=this.getInnerTop()+32?changed||this._buttonHovered!==(capture=this._buttonHovered=!0):changed||this._buttonHovered!==(capture=this._buttonHovered=!1),changed=changed||this._sliderHovered!==(capture=capture||(this._sliderHovered=args.x>=sl-9&&args.x<=sl+9&&args.y>=st-9&&args.y<=st+9)),this._capture=capture,changed&&this.positionChange.invoke(this,{position:this._position,animation:this._sliderAnimated})}}),B.Slider.method("_onMouseUp",function(args){this._buttonHovered&&!this._sliderDragged&&(this._sliderAnimated=!this._sliderAnimated,this._sliderAnimated&&1===this._position&&(this._position=0),this._sliderAnimatedPrevTime=new Date,this.positionChange.invoke(this,{position:this._position,animation:this._sliderAnimated})),this._sliderDragged=!1,this._capture=this._buttonHovered||this._sliderHovered}),B.Slider.method("_onAnimationFrame",function(args){if(this._sliderAnimated){var time=new Date,delta=(time-this._sliderAnimatedPrevTime)*this._speed/1e3/(this._ticks.length-1);this._position=Utils.Number.normalize(this._position+delta),1===this._position&&(this._sliderAnimated=!1),this._sliderAnimatedPrevTime=time,this.positionChange.invoke(this,{position:this._position,animation:this._sliderAnimated})}}),B.Slider.property("position",{value:0,get:!0,set:function(value){this._position=value,this.positionChange.invoke(this,{position:this._position,animation:this._sliderAnimated})}}),B.Slider.property("ticks",{value:null,get:!0,set:function(value){if(this._ticks!==value&&(this._ticks=[],value))for(var i=0;i<value.length;i++)this._ticks.push(new B.SliderTick(value[i]))}}),B.Slider.property("speed",{value:1,get:!0,set:!0}),B.Slider.method("floor",function(){return this._ticks[Math.floor(this._position*(this._ticks.length-1))].getPath()}),B.Slider.method("offset",function(){return this._position*(this._ticks.length-1)-Math.floor(this._position*(this._ticks.length-1))}),B.Slider.method("ceil",function(){return this._ticks[Math.ceil(this._position*(this._ticks.length-1))].getPath()}),B.Slider.method("reflow",function(space){if(!this._assertReflow(!this._ticks||this._ticks.length<2)){for(var height=0,i=0;i<this._ticks.length;i++)this._ticks[i].setContext(this._context),this._ticks[i].setHAlign(B.HAlign.auto),this._ticks[i].setVAlign(B.VAlign.auto),this._ticks[i].reflow(space),height=Math.max(height,this._ticks[i].getHeight());this._vAlign!==B.VAlign.none&&(this._height=Math.max(21+height,32),this._height=this._height-this.getInnerHeight()+this._height),B.Slider.base.reflow.apply(this,arguments);var start=this.getInnerLeft()+32+this._padding.getLeft()+this._startPadding(),length=this.getInnerLeft()+this.getInnerWidth()-start-this._endPadding();for(i=0;i<this._ticks.length;i++)this._ticks[i].setLeft(start+i*length/(this._ticks.length-1)-this._ticks[i].getWidth()/2),this._ticks[i].setTop(this.getInnerTop()+16+9)}}),B.Slider.method("repaint",function(){if(!this._assertRepaint(!this._ticks||this._ticks.length<2)){this._context.fillStyle=this._buttonHovered?"#888888":"#BBBBBB",this._context.beginPath(),this._sliderAnimated?(this._context.moveTo(this.getInnerLeft(),this.getInnerTop()),this._context.lineTo(this.getInnerLeft(),this.getInnerTop()+32),this._context.lineTo(this.getInnerLeft()+10,this.getInnerTop()+32),this._context.lineTo(this.getInnerLeft()+10,this.getInnerTop()),this._context.lineTo(this.getInnerLeft(),this.getInnerTop()),this._context.moveTo(this.getInnerLeft()+22,this.getInnerTop()),this._context.lineTo(this.getInnerLeft()+22,this.getInnerTop()+32),this._context.lineTo(this.getInnerLeft()+32,this.getInnerTop()+32),this._context.lineTo(this.getInnerLeft()+32,this.getInnerTop()),this._context.lineTo(this.getInnerLeft()+22,this.getInnerTop())):(this._context.moveTo(this.getInnerLeft(),this.getInnerTop()),this._context.lineTo(this.getInnerLeft()+32,this.getInnerTop()+16),this._context.lineTo(this.getInnerLeft(),this.getInnerTop()+32),this._context.closePath()),this._context.fill(),this._context.fillStyle="#BBBBBB";var start=this.getInnerLeft()+32+this._padding.getLeft(),length=this.getInnerLeft()+this.getInnerWidth()-start;this._context.fillRect(start,this.getInnerTop()+16-2,length,5),start+=this._startPadding(),length-=this._startPadding()+this._endPadding();for(var i=0;i<this._ticks.length;i++)this._context.fillStyle="#BBBBBB",this._context.beginPath(),this._context.arc(start+i*length/(this._ticks.length-1),this.getInnerTop()+16.5,5,0,2*Math.PI),this._context.fill(),this._ticks[i].repaint();this._context.fillStyle=this._context.strokeStyle=this._sliderHovered?"#888888":"#BBBBBB",this._context.lineWidth=2,this._context.globalAlpha=.5,this._context.beginPath(),this._context.arc(start+length*this._position,this.getInnerTop()+16.5,10,0,2*Math.PI),this._context.fill(),this._context.globalAlpha=1,this._context.stroke(),this._context.fillStyle=this._context.strokeStyle="#888888",this._context.beginPath(),this._context.arc(start+length*this._position,this.getInnerTop()+16.5,2,0,2*Math.PI),this._context.fill()}}),B.SliderTick=cls("B.SliderTick",B.Label),B.SliderTick.property("path",{value:null,get:!0,set:!0}),B.Chart=cls("B.Chart",B.Control,function(options){delegate(this,"_onSliderPositionChange"),delegate(this,"_onPlotScaleChange"),delegate(this,"_onBubbleHover"),delegate(this,"_onBubbleStateChange"),delegate(this,"_onChildInvalidated"),B.Chart.base.constructor.apply(this,arguments)}),B.Chart.property("palette",{value:["#82BAB6","#B1CA40","#EBAF36","#60A1FA","#FF462C","#933DA8","#FFD900","#FF9191","#6BBC80","#A0CBC8","#C3D66C","#EFC164","#86B7FB","#FF705B","#AC6BBC","#FFE23D","#FFABAB","#8ECC9E","#B7D7D5","#D2E090","#F3D08B","#A3C8FC","#FF9384","#C08ECC","#FFE86A","#FFBFBF","#A9D8B5","#CDE3E2","#DFE9B2","#F7DFAF","#C0D9FD","#FFB6AC","#E9D8ED","#FFEF99","#FFD3D3"],get:!0,set:!0}),B.Chart.property("context",{value:null,get:!0,set:function(value){this._context&&this._unbindNative(this._context.canvas),this._context=value,this._context&&this._bindNative(this._context.canvas)}}),B.Chart.property("data",{value:null,get:!0,set:!0,type:B.Data}),B.Chart.property("xTransformer",{value:null,get:!0,set:!0,type:B.Transformer}),B.Chart.property("yTransformer",{value:null,get:!0,set:!0,type:B.Transformer}),B.Chart.property("rTransformer",{value:null,get:!0,set:!0,type:B.Transformer}),B.Chart.property("cTransformer",{value:null,get:!0,set:!0,type:B.ColorTransformer}),B.Chart.property("bubbles",{value:null,get:!0,set:function(value){if(this._hoveredBubble=null,this._bubbles!==value){var i;if(value)for(i=0;i<value.length;i++){var newBubble=value[i],oldBubble=null,id=newBubble.path[0];if(this._bubbles&&id)for(var j=0;j<this._bubbles.length&&!oldBubble;j++)this._bubbles[j].getPath()[0]===id&&(oldBubble=this._bubbles[j]);oldBubble?(oldBubble.update(newBubble),value[i]=newBubble=oldBubble):(value[i]=newBubble=new B.Bubble(newBubble),newBubble.hover.add(this._onBubbleHover),newBubble.invalidated.add(this._onChildInvalidated),newBubble.stateChange.add(this._onBubbleStateChange))}var queue=[];if(this._bubbles){for(i=0;i<this._bubbles.length;i++)-1===value.indexOf(this._bubbles[i])?(queue.push(this._bubbles[i]),this._bubbles[i].setState(B.Bubble.States.disappearing)):(queue.unshift(i,0),value.splice.apply(value,queue),queue=[]);queue.length&&(value=value.concat(queue))}this._bubbles=value}}}),B.Chart.property("title",{value:null,get:!0,set:!0,type:B.Label}),B.Chart.property("plot",{value:null,get:!0,set:function(value){this._plot!==value&&(this._plot&&this._plot.scaleChange.remove(this._onPlotScaleChange),value instanceof B.Plot||(value=new B.Plot(value)),this._plot=value,this._plot&&this._plot.scaleChange.add(this._onPlotScaleChange))},type:B.Plot}),B.Chart.property("slider",{value:null,get:!0,set:function(value){this._slider&&this._slider.positionChange.remove(this._onSliderPositionChange),value instanceof B.Slider||(value=new B.Slider(value)),this._slider=value,this._slider&&this._slider.positionChange.add(this._onSliderPositionChange)},type:B.Slider}),B.Chart.property("bubblesLegend",{value:null,get:!0,set:!0,type:B.Legend}),B.Chart.property("colorLegend",{value:null,get:!0,set:!0,type:B.ValueLegend}),B.Chart.property("radiusLegend",{value:null,get:!0,set:!0,type:B.ValueLegend}),B.Chart.property("tooltip",{value:null,get:!0,set:!0,type:B.Tooltip}),B.Chart.method("_onSliderPositionChange",function(sender,args){this._updateData(args.animation),this.repaint()}),B.Chart.method("_onPlotScaleChange",function(sender,args){this._plot.reflow(this._plot.getOuterRect());var labels;this._plot&&this._plot.getX()&&(labels=this._plot.getX().getLabels())&&labels.reflow(labels.getOuterRect(),!0),this._plot&&this._plot.getY()&&(labels=this._plot.getY().getLabels())&&labels.reflow(labels.getOuterRect(),!0),this._updateData(!0),this.repaint()}),B.Chart.method("_onBubbleHover",function(sender,args){sender===this._hoveredBubble&&args.hover||args.cancel||(this._hoveredBubble=args.hover?sender:null,this._reflowTooltip(),this.invalidate(!1,!0))}),B.Chart.method("_onBubbleStateChange",function(sender,args){if(sender.getState()===B.Bubble.States.disappeared){var i=this._bubbles.indexOf(sender);this._bubbles[i].hover.remove(this._onBubbleHover),this._bubbles[i].invalidated.remove(this._onChildInvalidated),this._bubbles[i].stateChange.remove(this._onBubbleStateChange),this._bubbles.splice(i,1)}}),B.Chart.method("_onChildInvalidated",function(sender,args){this.invalidate(!1,!0)}),B.Chart.method("_handle",function(args){if(this._invalidateArgs&&this._invalidate(),this._bubbles)for(var i=this._bubbles.length-1;i>=0;i--)this._bubbles[i]._handle(args);this._plot&&this._plot._handle(args),this._slider&&this._slider._handle(args),this._invalidate(args.reflow,args.repaint)}),B.Chart.method("_updateData",function(isAnimation){if(this._plot){for(var bubbles=this._bubbles.filter(function(bubble){return bubble.getState()!==B.Bubble.States.disappearing}),sliderF=this._slider.floor(),sliderO=this._slider.offset(),sliderC=this._slider.ceil(),scale=this._plot.getScale(),i=0;i<bubbles.length;i++){var bubble=bubbles[i],pathF=bubble.getPath().concat(sliderF),pathC=bubble.getPath().concat(sliderC);bubble.setContext(this._context),this._xTransformer&&bubble.setX(scale.x(this._xTransformer.transformedItem(pathF,pathC,sliderO))),this._yTransformer&&bubble.setY(scale.y(1-this._yTransformer.transformedItem(pathF,pathC,sliderO))),isAnimation||bubble.getState()!==B.Bubble.States.waiting||bubble.skip(),this._rTransformer&&bubble.setR(50*this._rTransformer.transformedItem(pathF,pathC,sliderO)),this._cTransformer&&this._cTransformer.getPath()?bubble.setColor(this._cTransformer.transformedItem(pathF,pathC,sliderO)):bubble.setColor(this._palette[i%this._palette.length]),isAnimation&&bubble.skip()}for(bubbles=this._bubbles.filter(function(bubble){return bubble.getState()===B.Bubble.States.disappearing}),i=0;i<bubbles.length;i++)bubbles[i].setContext(this._context),bubbles[i].setR(0),isAnimation&&bubble.skip()}}),B.Chart.property("_hoveredBubble"),B.Chart.method("_reflowTooltip",function(){if(this._plot&&this._tooltip)if(this._hoveredBubble){var value,sliderF=this._slider.floor(),sliderO=this._slider.offset(),sliderC=this._slider.ceil(),pathF=this._hoveredBubble.getPath().concat(sliderF),pathC=this._hoveredBubble.getPath().concat(sliderC),name=this._data.name([""].concat(this._hoveredBubble.getPath())),nameF=this._data.name([""].concat(pathF)),nameC=this._data.name([""].concat(pathC)),lines=[name+", "+(nameF===nameC?nameF:nameF+" - "+nameC)];this._xTransformer&&this._xTransformer.name()&&lines.push(this._xTransformer.name()+": "+(null!==(value=this._xTransformer.item(pathF,pathC,sliderO))?value.toFixed(2):"no data")),this._yTransformer&&this._yTransformer.name()&&lines.push(this._yTransformer.name()+": "+(null!==(value=this._yTransformer.item(pathF,pathC,sliderO))?value.toFixed(2):"no data")),this._rTransformer&&this._rTransformer.name()&&lines.push(this._rTransformer.name()+": "+(null!==(value=this._rTransformer.item(pathF,pathC,sliderO))?value.toFixed(2):"no data")),this._cTransformer&&this._cTransformer.name()&&lines.push(this._cTransformer.name()+": "+(null!==(value=this._cTransformer.item(pathF,pathC,sliderO))?value.toFixed(2):"no data")),this._tooltip.setText(Utils.Array.unique(lines).join("\n")),this._tooltip.setContext(this._context),this._tooltip.setVisible(!0),this._tooltip.setX(this._hoveredBubble.getX()),this._tooltip.setY(this._hoveredBubble.getY()),this._tooltip.setOffset(this._hoveredBubble.getR()),this._tooltip.getBorder().setColor(this._hoveredBubble.getColor()),this._tooltip.reflow(this._plot.getInnerRect())}else this._tooltip.setVisible(!1)}),B.Chart.method("reflow",function(space){if(!this._assertReflow()){this._hAlign!==B.HAlign.none&&(this._left=space.getLeft(),this._width=space.getWidth()),this._vAlign!==B.VAlign.none&&(this._top=space.getTop(),this._height=space.getHeight());var innerSpace=new B.Rect({left:this.getInnerLeft(),top:this.getInnerTop(),width:this.getInnerWidth(),height:this.getInnerHeight()});if(this._title&&(this._title.setContext(this._context),this._title.setHAlign(B.HAlign.center),this._title.setVAlign(B.VAlign.top),this._title.reflow(innerSpace),innerSpace.setTop(innerSpace.getTop()+this._title.getHeight()),innerSpace.setHeight(innerSpace.getHeight()-this._title.getHeight())),this._slider){this._slider.setContext(this._context),this._slider.setHAlign(B.HAlign.fit),this._slider.setVAlign(B.VAlign.bottom);for(var ticks=this._slider.getTicks(),i=0;i<ticks.length;i++)ticks[i].setText(this._data.name(["",""].concat(ticks[i].getPath())));this._slider.reflow(innerSpace),innerSpace.setHeight(innerSpace.getHeight()-this._slider.getHeight())}this._xTransformer&&this._xTransformer.setData(this._data),this._yTransformer&&this._yTransformer.setData(this._data),this._rTransformer&&this._rTransformer.setData(this._data),this._cTransformer&&this._cTransformer.setData(this._data);var legendSpace=innerSpace.clone(),legendHeight=0,legendVAlign=B.VAlign.bottom;if(this._rTransformer&&this._rTransformer.getPath()&&this._radiusLegend&&(this._radiusLegend.setContext(this._context),this._radiusLegend.setTransformer(this._rTransformer),this._radiusLegend.setHAlign(B.HAlign.right),this._radiusLegend.setVAlign(B.VAlign.bottom),this._radiusLegend.reflow(legendSpace),legendSpace.setTop(this._radiusLegend.getTop()),legendSpace.setHeight(this._radiusLegend.getHeight()),legendSpace.setWidth(this._radiusLegend.getLeft()-legendSpace.getLeft()),legendHeight=Math.max(this._radiusLegend.getHeight(),legendHeight),legendVAlign=B.VAlign.top),this._cTransformer&&this._cTransformer.getPath()&&this._colorLegend&&(this._colorLegend.setContext(this._context),this._colorLegend.setTransformer(this._cTransformer),this._colorLegend.setHAlign(B.HAlign.left),this._colorLegend.setVAlign(legendVAlign),this._colorLegend.reflow(legendSpace),legendHeight=Math.max(this._colorLegend.getHeight(),legendHeight)),(!this._cTransformer||!this._cTransformer.getPath())&&this._bubblesLegend&&this._plot&&this._bubbles){var bubbles=this._bubbles.filter(function(bubble){return bubble.getState()!==B.Bubble.States.disappearing}),items=[];for(i=0;i<bubbles.length;i++)items.push({text:this._data.name([""].concat(bubbles[i].getPath())),color:this._palette[i%this._palette.length]});this._bubblesLegend.setContext(this._context),this._bubblesLegend.setItems(items),this._bubblesLegend.setHAlign(B.HAlign.left),this._bubblesLegend.setVAlign(legendVAlign),this._bubblesLegend.reflow(legendSpace),legendHeight=Math.max(this._bubblesLegend.getHeight(),legendHeight)}innerSpace.setHeight(innerSpace.getHeight()-legendHeight);var title;this._plot&&this._plot.getX()&&(title=this._plot.getX().getTitle())&&(title.setContext(this._context),title.setHAlign(B.HAlign.center),title.setVAlign(B.VAlign.bottom),title.setText(this._xTransformer.name()),title.reflow(innerSpace),innerSpace.setHeight(title.getTop()-innerSpace.getTop())),this._plot&&this._plot.getX()&&(title=this._plot.getY().getTitle())&&(title.setContext(this._context),title.setHAlign(B.HAlign.left),title.setVAlign(B.VAlign.center),title.setDirection(B.Direction.up),title.setText(this._yTransformer.name()),title.reflow(innerSpace),innerSpace.setLeft(title.getLeft()+title.getWidth()),innerSpace.setWidth(innerSpace.getWidth()-title.getWidth()));var labels,labelsBottom=innerSpace.getBottom(),scale=this._plot.getScale();this._plot.setPadding(0),this._plot.update(innerSpace.serialize()),scale.update(this._plot.getInnerRect().serialize()),scale.setPadding(50),this._plot&&this._plot.getX()&&(labels=this._plot.getX().getLabels())&&(labels.setContext(this._context),labels.setTransformer(this._xTransformer),labels.setMin(this._xTransformer.getMinItem()),labels.setMax(this._xTransformer.getMaxItem()),labels.setHAlign(B.HAlign.fit),labels.setVAlign(B.VAlign.bottom),labels.setDirection(B.Direction.right),labels.setScale(scale),labels.reflow(innerSpace),innerSpace.setHeight(labels.getTop()-innerSpace.getTop()),this._plot.update(innerSpace.serialize()),scale.update(this._plot.getInnerRect().serialize())),this._plot&&this._plot.getY()&&(labels=this._plot.getY().getLabels())&&(labels.setContext(this._context),labels.setTransformer(this._yTransformer),labels.setMin(this._yTransformer.getMinItem()),labels.setMax(this._yTransformer.getMaxItem()),labels.setHAlign(B.HAlign.left),labels.setVAlign(B.VAlign.fit),labels.setDirection(B.Direction.up),labels.setScale(scale),labels.reflow(innerSpace),innerSpace.setLeft(labels.getLeft()+labels.getWidth()),innerSpace.setWidth(innerSpace.getWidth()-labels.getWidth()),this._plot.update(innerSpace.serialize()),scale.update(this._plot.getInnerRect().serialize()),this._plot&&this._plot.getX()&&(labels=this._plot.getX().getLabels())&&(innerSpace.setHeight(labelsBottom-innerSpace.getTop()),labels.reflow(innerSpace),innerSpace.setHeight(labels.getTop()-innerSpace.getTop())));var grid;this._plot&&this._plot.getX()&&(grid=this._plot.getX().getGrid())&&(grid.setTransformer(this._xTransformer),grid.setMin(this._xTransformer.getMinItem()),grid.setMax(this._xTransformer.getMaxItem()),grid.setScale(scale),grid.setDirection(B.Direction.right)),this._plot&&this._plot.getY()&&(grid=this._plot.getY().getGrid())&&(grid.setTransformer(this._yTransformer),grid.setMin(this._yTransformer.getMinItem()),grid.setMax(this._yTransformer.getMaxItem()),grid.setScale(scale),grid.setDirection(B.Direction.up)),this._plot&&(this._plot.setContext(this._context),this._plot.setHAlign(B.HAlign.fit),this._plot.setVAlign(B.VAlign.fit),this._plot.reflow(innerSpace)),this._updateData(),this._reflowTooltip(),B.Chart.base.reflow.apply(this,arguments)}}),B.Chart.method("repaint",function(){if(!this._assertRepaint()){this._context.canvas.width=this._context.canvas.width,B.Chart.base.repaint.apply(this,arguments),this._title&&this._title.repaint(),this._slider&&this._slider.repaint(),this._rTransformer&&this._rTransformer.getPath()&&this._radiusLegend&&this._radiusLegend.repaint(),this._cTransformer&&this._cTransformer.getPath()&&this._colorLegend&&this._colorLegend.repaint(),this._cTransformer&&this._cTransformer.getPath()||!this._bubblesLegend||!this._plot||!this._bubbles||this._bubblesLegend.repaint();var title;this._plot&&this._plot.getX()&&(title=this._plot.getX().getTitle())&&title.repaint(),this._plot&&this._plot.getY()&&(title=this._plot.getY().getTitle())&&title.repaint();var labels;if(this._plot&&this._plot.getX()&&(labels=this._plot.getX().getLabels())&&labels.repaint(),this._plot&&this._plot.getY()&&(labels=this._plot.getY().getLabels())&&labels.repaint(),this._plot&&(this._plot._clip(),this._plot.repaint()),this._bubbles)for(var i=0;i<this._bubbles.length;i++)this._bubbles[i].repaint();this._tooltip&&this._tooltip.repaint(),this._plot&&this._plot._unclip()}}),B.Chart["default"]={title:{text:"Title",font:{color:"#888888"}},hAlign:B.HAlign.fit,vAlign:B.VAlign.fit,xTransformer:{},yTransformer:{},cTransformer:{},rTransformer:{min:.2,nodata:.1},bubbles:[],plot:{border:{color:"#BBBBBB",Width:4},background:"#EEEEEE",hAlign:B.HAlign.none,vAlign:B.VAlign.none,x:{title:{text:"X",font:{color:"#888888"}},grid:{count:5,options:{stroke:{color:"#FFFFFF",width:2}},subcollection:{count:5,options:{stroke:{color:"#FFFFFF",width:1}}}},labels:{count:5,options:{font:{color:"#888888"}},subcollection:{count:5,options:{font:{color:"#888888"}}}}},y:{title:{text:"Y",font:{color:"#888888"}},grid:{count:5,options:{stroke:{color:"#FFFFFF",width:2}},subcollection:{count:5,options:{stroke:{color:"#FFFFFF",width:1}}}},labels:{count:5,options:{font:{color:"#888888"}},subcollection:{count:5,options:{font:{color:"#888888"}}}}}},slider:{},colorLegend:{title:{font:{color:"#888888"}},font:{color:"#888888"}},radiusLegend:{title:{font:{color:"#888888"}},font:{color:"#888888"}},bubblesLegend:{title:{text:"Bubbles",font:{color:"#888888"}},font:{color:"#888888"}},tooltip:{font:{color:"#888888"},background:"rgba(255,255,255,0.5)",border:{width:1,radius:3},padding:0,margin:0}};
//# sourceMappingURL=bubblechart.min.js.map
})();